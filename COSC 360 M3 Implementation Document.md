# COSC 360 M3 - Implementation 

## Team members:
- Luke Roblesky
- Jacob Harding

## Deployed Site:
[http://cosc360.ok.ubc.ca/jake10/the-project-luke-and-jacob-cosc-360/src/server/index.php](http://cosc360.ok.ubc.ca/jake10/the-project-luke-and-jacob-cosc-360/src/server/index.php)

## Site Implementation Overview
<p>All php files when creating a connection to the database use the file dbUtil.php which contains a function which returns a database connection. These php files then use the database connection when executing all sql statements.</p>

<p>The site contains several asynchronous features, which are all implemented using JQuery’s ajax functions, mainly the get, post, and general case ajax function.</p>

<p>When an ajax request is made for data that is to be displayed as html, JQuery is used to create the elements and add the data from the request and style the elements. For example, the submit comment button uses JQuery to send a request to the file submitComment.php which adds the comment data to the database, then sends back the comment data which is then displayed using JQuery.</p>

<p>The user's password is stored as an encrypted md5 hash for security.</p>

<p>The main session variable which is set to keep track of whether the user is logged in is ‘user_logged_in’. This variable is used to adjust the displayed html to whether the user is logged in or not. If the user is logged in, where ‘user_logged_in’ is set and has the value of the logged in user’s username, the username is then used to query the database for the rest of the user’s info that is needed to be displayed in any html. For example, the username and user image of the user are displayed in the header when the user is logged in as links (\<a\> tags) to the user account page. The user account page, userAccount.php, also uses the ‘user_logged_in’ session variable to ensure the user is logged in, then displays the user info corresponding to the user. If the user is not logged in, the page redirects the user back to the home page (index.php).</p>

## Implemented Features:
- The signup.php file uses the signup.js file to do client side form validation. This validation ensures that the user registration data is valid before sending it to the server. Specifically, it checks to make sure that all the form inputs, excluding the optimal user image, have been filled and that their formats are correct. The client side validation is done mainly using the javascript function avaiable for string variables 'search' which can match the inputs with a regular expression. If the data passes the client side validation the form is allowed to submit the data (preventDefault() is not called) to the authenticateSignup.php file on the server, which then connects to the database and adds the new user's data to the database.
- login.php makes an AJAX request to authentication.php when the login button is pressed. authentication.php connects to the database and checks that the username and password match an existing user and if so, sets the session variable 'user_logged_in' such that any other pages visited on the site are able to recognize the user's logged in status. 
- The user can browse for threads using a pagination technique, where four threads are displayed at a time in the left column. The left and right arrow buttons can be used to browse different threads. There is a number input that can also be used to jump to a specific page. The thread card data is loaded asynchronously using  an AJAX request, specifically JQuery’s ‘get’ method to the file ‘getThreadCards.php’. In the get request, the page number that the user is navigating to is sent as data. getThreadCards.php then queries the database for the details of the four threads that correspond to the page number and sends that data back, which is then dynamically displayed in the browser.
- The user can search for threads on the main page (index.php) using the search bar in the left column. This feature functions similarly to the pagination feature where a get request is made, but this time the data is the search text that the user inputted. The returned thread cards are the first four (or less) threads that have the sequence of characters that the user searched for in their title. 
- Clicking on a thread ‘card’ in the left column will load the thread in the right column including the main thread post and all the comments to the thread. Each thread card, when it is loaded using AJAX, is displayed using an \<a\> tag which has an href to the home page (index.php) with a get url parameter of the thread's id. So a thread card will link to a page something like index.php?thread=5 which is the same page, but the php code will detect the thread parameter which is set to the thread id (5) and then make an AJAX request to get the data for the thread corresponding to that id and then display it in the right column along with all the comments for that thread. The html for the thread specifically is echoed out from the ‘getThread.php’ file and the thread comments are echoed out from the ‘getThreadComments.php’ file.
- The user can create new threads if they are logged in using the ‘Create Thread’ button in the site header. That button (which is an \<a\> tag) will redirect to the page ‘userCreateThreadPage.php’ where the user can enter the title, text content, and topic of the thread they want to create and then post the thread. The userCreateThreadPage.php file has the userCreateThread.js file which attaches an event listener function to the post thread button. The function does form validation to make sure all inputs have content in them, for example the user can’t post a thread with no title. This javascript file uses the ‘preventDefault’ function to stop the thread data from being automatically submitted. In the case that all the input is valid, a post request is made to userCreateThread.php with the post data being the thread title, thread content, and thread topic that the user entered. userCreateThread.php then adds this data to the database and if no errors were encountered sends back a JSON message with a createdThreadId property which is the id for the newly created thread. The userCreateThread.js file then redirects the user to the url for the specific thread that was just created by the user.
- When the user is on a thread page, which is any index.php page which may have a particular thread id get parameter after it (e.g. index.php?thread=5), an AJAX request is made every second to check for newly created comments that may have been made after the user loaded the page. The javascript code is in the getThreadComments.js file. It uses the setInterval method to call the method asyncLoadNewComments every second. Every time asyncLoadNewComments is run, it makes an AJAX request to getNewCommentsAJAX.php. getNewCommentsAJAX.php sets a session variable called last_check_time which contains the time of the latest comment that has been sent back to the client and loaded. In this file, the database is queried to find any thread comments which have a time that is more recent that last_check_time, if there are any, last_check_time is set to the time that thread comment was created, and then the data for that thread comment is sent back to the client to be dynamically displayed without the page reloading.
- The user's username and user image in the header link to the page 'userAccount.php' where the user can edit their account info. userAccount.php retrieves the user info from the database for the user specified by the session variable ‘user_logged_in’. It then echoes out the data into html which is sent to the client. userAccount.php also sends to the client the userAccount.js file which manages user click events for when the user is editing their account details. When the user clicks the 'Edit Details' button, the read-only attributes of the two input fields containing the user's username and email is removed so that the user can edit them. Also, after clicking the 'Edit Details' button, two buttons are displayed, the 'Cancel' and 'Save Changes' buttons which control if the user's changes should be saved or cancelled. When the user clicks the 'Save Changes' button, an AJAX request is made to the server to the file changeUserAccountInfo.php with the new account info. changeUserAccountInfo.php will check the new account info, and if the username and email have not already been used by another user will update the info. If either the new username or new email has already been used, changeUserAccountInfo.php sends back a JSON response which contains an error message informing the user that the username or new email has already been used. 
- On the userAccount.php, the user can also change their user image by clicking on their current image and selecting a new one in the file browser. Once the user selects a new image, the client side javascript detects this with a 'onchange' event and sends the new image data using an ajax request to changeUserImage.php on the server. changeUserImage.php then connects to the database and updates the user's image to the new image. 
- Lastly on the userAccount.php page is a link to the changePassword.php page. The changePassword.php page's output uses the javascript file changePassword.js to due validation to ensure the new password and confirm new password forms are the same before sending the new password data to the server. If the new password and confirm new password inputs match an AJAX request is made to changePasswordAJAX.php which connects to the database and changes the password. changePasswordAJAX.php double checks that the new password and confirm new password are the same and also checks to make sure the user entered their correct old password, if they did not a JSON response with an error message is sent which is then displayed to the client. If JSON response contains a status of 'success' JQuery is used to dynamically change the html of the page to show a message box telling the user that their password was successfully changed and provide a link back to the home page.
- If the user is an admin, which is noted using the 'admin' BOOLEAN field of the WebsiteUsers table, they will have access to the admin.php page. If a user which is not an admin tries to access the admin.php page, they are redirected back to the home page using the php location header: header("Location: index.php"). On this page, there is a search bar for the admin to search for all users by username, email, or post title. The search string is sent using AJAX to the getAdminSearch.php which returns the html data for all the users which match the search. There are event listeners in admin.js which detect clicks on 'Manage User Posts' and 'Posting: Allowed.' Clicking 'Manage User Posts' performs a post request to adminManageUser.php, and passes in the username of the clicked user via a hidden input form. Clicking 'Posting:...' changes the html element value and performs an ajax request to getAdminPostingStatus.php which updates the corresponding value for the user's posting permission in the database.
- 

## Known Site Limitations
- The password recovery feature is not completely implemented as there was difficulty using the mail() function to send an email to the user.
- The sort by feature in the thread navigation column is not currently working.
